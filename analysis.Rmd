---
title: "analysis"
output: html_document
date: '2022-09-14'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyr)
library(MASS)
library(lubridate)
library(rjags)
library(stringr)
library(ggplot2)
library(HDInterval)
library(INLA)
```
Interesting questions: competing risks: a lot of people died during covid; at some point we should see a decline in overall death rates below baseline because of this 'harvesting' effect. in which groups will this be most apparent?
https://www.bmj.com/content/373/bmj.n1137

Kissler and Grad: https://academic.oup.com/aje/article/191/8/1519/6572389

Analysis idea; define excess death rate by 5 year age bin. (e.g., simple approach, annual incidence in previous year vs 2020 with trend adjustment; annual deaths; use bayesian model)

Deaths in year y, age group i:
 N_deaths_y_i ~ Poisson (lambda_y_i)
 log(lambda_y_i) = log(pop_y_i) + alpha_i +beta1_i*t + beta2_i*ind2020
 beta1_i ~dnorm(rho1*beta1_(i-1), tau) 
 
```{r}
a1 <- readRDS('./Data/all_cause_deaths_age_race_sex_year.rds')
#Uses age recode 27
#https://www.cdc.gov/nchs/data/dvs/Multiple-Cause-Record-Layout-2020.pdf 

a2 <- a1 %>%
  group_by(agey,race_recode, month, year,sex) %>%
  mutate(agey = if_else(agey>85,85, agey)) %>%
  filter(agey !=999) %>%
  summarize(N_deaths=sum(N_deaths)) %>%
  ungroup() %>%
    tidyr::complete(agey,race_recode, month, year,sex, fill=list(N_deaths=0)) %>% #fills 0s
  mutate(date=as.Date(paste(year, month, '01', sep='-'), format='%Y-%m-%d'),
    agec = if_else(agey<35,1,
           if_else( agey<45,2,
           if_else( agey<55,3,
           if_else( agey<65,4,
           if_else( agey<75,5,
           if_else( agey<85,6,7                          ))))))
  )


pop1 <- readRDS('./Data/pop_interpol_single_age.rds')

a3 <- full_join(a2, pop1, by=c('agey','sex','race_recode','date')) %>%
  mutate(    agec = as.factor(agec),
    race_recode= as.factor(race_recode)
    ) %>%
  filter( !is.na(pop.interpol) & !is.na(pop.interpol) & year >= 2014) %>%
  mutate(N_deaths = if_else(is.na(N_deaths),0, N_deaths),
         month=as.factor(month(date)),
         pandemic_period= if_else(date>='2020-04-01',1,0), #START APRIl 1 (QTR2)
         year= year(date))
```

  
   RACE_RECODE: 
    1=Non-Hispanic White
   2=Non-Hispanic- Black
   3= Hispanic
   4=American Indian/Native Alaskan
   5= Asian/Pacific Island
   999=Missing
   
```{r}

mod1 <- glm.nb(N_deaths ~ pandemic_period*race_recode + 
              pandemic_period*sex + 
              year + 
              month + 
              pandemic_period*agec + 
              offset(log(pop.interpol)),  data=a3  )

summary(mod1)


```


## Single group by age
```{r}


b1 <- a3 %>%
  mutate(qtr=as.factor(quarter(date))) %>%
  group_by(qtr,pandemic_period, agey) %>%
  summarize(N_deaths=sum(N_deaths), pop=sum(pop.interpol)) %>%
  mutate(log.offset=log(pop/100000))

mod.test <- glm(N_deaths ~ offset(log.offset) +agey, data=b1, family='poisson')
```



```{r}

mod.mat <- model.matrix(~ agey +pandemic_period +qtr, data=b1)

model_string <- "
model{
for(t in 1:N_times){ 
  N_deaths[t] ~ dnegbin(prob[t],r)
  prob[t]<- r/(r+lambda[t])
  
  #N_deaths[t] ~ dpois(lambda[t])
  
  log(lambda[t]) <- ( int  + log.offset[t] + beta[agey[t]+1] + pandemic[t]*delta[agey[t]+1] )

}
  
  beta[1] ~ dnorm(0, (1-rho^2)*tau.beta)
  baseline_prob[1] <- beta[1] +int
  
  for(i in 2:86){
      beta[i] ~ dnorm(rho*beta[i-1], tau.beta) #AR(1) model
      baseline_prob[i] <- beta[i] +int
  }
  
  delta[1] ~ dnorm(0, (1-rho2^2)*tau.delta)
    for(i in 2:86){
      delta[i] ~ dnorm(rho2*delta[i-1], tau.delta) #AR(1) model
  }
  
   int ~ dnorm(0, 1e-4)
   
   tau.beta~ dgamma(3, 2)
   tau.delta~ dgamma(3,2)

   rho ~ dunif(-1,1)
   rho2 ~ dunif(-1,1)
   
    r ~ dunif(0,250)

 }
"
##############################################################
#Model Fitting
##############################################################
inits1=list(".RNG.seed"=c(123), ".RNG.name"='base::Wichmann-Hill')
inits2=list(".RNG.seed"=c(456), ".RNG.name"='base::Wichmann-Hill')
inits3=list(".RNG.seed"=c(789), ".RNG.name"='base::Wichmann-Hill')
##############################################
#Model Organization
##############################################
model_spec<-textConnection(model_string)
model_jags<-jags.model(model_spec, 
                       inits=list(inits1,inits2, inits3),
                       data=list('N_deaths'=b1$N_deaths ,
                                 'N_times'=nrow(b1) ,
                                 'log.offset'=b1$log.offset,
                                 'agey'=b1$agey,
                                 'pandemic'=b1$pandemic_period
                                    ),
                       n.adapt=10000, 
                       n.chains=3)

params<-c( 'beta','delta','rho','tau.beta','int','baseline_prob')
##############################################
#Posterior Sampling
##############################################
posterior_samples<-coda.samples(model_jags, 
                                params, 
                                n.iter=10000)
posterior_samples.all<-do.call(rbind,posterior_samples)

saveRDS(posterior_samples.all, './Results/posteriors.rds')
```


```{r}
#post1.summary<-summary(posterior_samples)
#post_means<-colMeans(posterior_samples.all)
post_means<-apply(posterior_samples.all, 2, mean)
sample.labs<-names(post_means)
ci<-t(hdi(posterior_samples.all, credMass = 0.95))
#ci<-matrix(sprintf("%.1f",round(ci,1)), ncol=2)
ci<-matrix(ci, ncol=2)
row.names(ci)<-sample.labs
#post_means<-sprintf("%.1f",round(post_means,1))
names(post_means)<-sample.labs
indices <- str_extract_all(names(post_means), "(?<=\\[).+?(?=\\])")
rep1 <- sapply(indices, function(x) identical(x, character(0))) #is it missing ie character(0)
indices[which(rep1==1)] <- '999'
index_n <- as.numeric(unlist(indices))

combined <- cbind.data.frame(post_means, ci,index_n )

post_beta<- as.data.frame(combined[grep('beta',names(post_means)),]) %>%
  filter(index_n<=85)

post_delta<- as.data.frame(combined[grep('delta',names(post_means)),]) %>%
  filter(index_n<=85)

post_baseline_prob<- as.data.frame(combined[grep('baseline_prob',names(post_means)),]) 

# ggplot(post_beta, aes(x=index_n, y=exp(post_means))) +
#   theme_classic() +
#   geom_ribbon(aes(x=index_n, ymin=exp(`1`), ymax=exp(`2`)),fill='gray80') +
#   geom_line()+
#   ggtitle('Mortality ratio by Age') +
#     xlab('Age (years)')

ggplot(post_baseline_prob, aes(x=index_n, y=(post_means))) +
  theme_classic() +
  geom_ribbon(aes(x=index_n, ymin=(`1`), ymax=(`2`)),fill='gray80') +
  geom_line()+
  ggtitle('Log-Deaths/100000 per quarter') +
    xlab('Age (years)')


ggplot(post_baseline_prob, aes(x=index_n, y=exp(post_means))) +
  theme_classic() +
  geom_ribbon(aes(x=index_n, ymin=exp(`1`), ymax=exp(`2`)),fill='gray80') +
  geom_line()+
  ggtitle('Pre-pandemic rate of death') +
    xlab('Age (years)') +
  ylab('Deaths/100000 per quarter')

ggplot(post_delta, aes(x=index_n, y=exp(post_means))) +
  theme_classic() +
  geom_ribbon(aes(x=index_n, ymin=exp(`1`), ymax=exp(`2`)),fill='gray80') +
  geom_line()+
  ggtitle('Pandemic effect (RR) by Age') +
    xlab('Age (years)') +
  ylab('Pandemic effect (RR')

```
 
 