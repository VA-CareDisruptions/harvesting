---
title: "analysis"
output: html_document
date: '2022-09-14'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyr)
library(MASS)
library(lubridate)
library(dplyr)
library(rjags)
library(stringr)
library(ggplot2)
library(HDInterval)
library(readxl)
library(INLA)
source('./R/utils_kissler.R')
```
Interesting questions: competing risks: a lot of people died during covid; at some point we should see a decline in overall death rates below baseline because of this 'harvesting' effect. in which groups will this be most apparent?
https://www.bmj.com/content/373/bmj.n1137

Kissler and Grad: https://academic.oup.com/aje/article/191/8/1519/6572389

Analysis idea; define excess death rate by 5 year age bin. (e.g., simple approach, annual incidence in previous year vs 2020 with trend adjustment; annual deaths; use bayesian model)

Deaths in year y, age group i:
 N_deaths_y_i ~ Poisson (lambda_y_i)
 log(lambda_y_i) = log(pop_y_i) + alpha_i +beta1_i*t + beta2_i*ind2020
 beta1_i ~dnorm(rho1*beta1_(i-1), tau) 
 
```{r}
a1 <- readRDS('./Data/all_cause_deaths_age_race_sex_year.rds')
#Uses age recode 27
#https://www.cdc.gov/nchs/data/dvs/Multiple-Cause-Record-Layout-2020.pdf 

a2 <- a1 %>%
  group_by(agey, month, year,sex) %>%
  mutate(agey = if_else(agey>120,120, agey)) %>%
  filter(agey !=999) %>%
  summarize(N_deaths=sum(N_deaths)) %>%
  ungroup() %>%
    tidyr::complete(agey, month, year,sex, fill=list(N_deaths=0)) %>% #fills 0s
  mutate(date=as.Date(paste(year, month, '01', sep='-'), format='%Y-%m-%d'),
    agec = if_else(agey<35,1,
           if_else( agey<45,2,
           if_else( agey<55,3,
           if_else( agey<65,4,
           if_else( agey<75,5,
           if_else( agey<85,6,7                          ))))))
  )


#pop1 <- readRDS('./Data/pop_interpol_single_age.rds')
#https://www.census.gov/newsroom/press-kits/2020/population-estimates-detailed.html
#https://www.census.gov/data/tables/time-series/demo/popest/2020s-national-detail.html

pop1 <- read_excel('./Data/nc-est2019-syasexn.xlsx', sheet='compiled') %>%
  mutate(age=round(age*100)) %>%
 reshape2::melt( id.vars=c('age', 'sex')) %>%
  mutate(year=as.numeric(substring(variable,2)), month=7)

  months <- cbind.data.frame('month'=1:12)

  pop1a <-    bind_rows(pop1, months) %>%
    tidyr::complete( month, nesting(year,age,  sex), fill=list(pop=NA) ) %>%
    mutate(date= as.Date(paste(year, month, '01', sep='-'))) %>%
    filter(date>='2013-07-01')  %>%
    rename(pop=value, agey=age) %>%
    arrange(agey , sex,year, month) %>%
    group_by(agey, sex) %>%
    mutate(time= year + month/12 - 1/12 ) %>%
    mutate(pop.interpol=approx(time,pop,time)$y) %>%
    ungroup()%>%
    select(agey, sex, date, pop.interpol)

a3 <- full_join(a2, pop1a, by=c('agey','sex','date')) %>%
  mutate(    agec = as.factor(agec)
    ) %>%
  filter( !is.na(pop.interpol) & year >= 2014) %>%
  mutate(N_deaths = if_else(is.na(N_deaths),0, N_deaths),
         month=as.factor(month(date)),
         pandemic_period= if_else(date>='2020-04-01',1,0), #START APRIl 1 (QTR2)
         year= year(date))
```

  
   RACE_RECODE: 
    1=Non-Hispanic White
   2=Non-Hispanic- Black
   3= Hispanic
   4=American Indian/Native Alaskan
   5= Asian/Pacific Island
   999=Missing
   
```{r}

# mod1 <- glm.nb(N_deaths ~ pandemic_period*race_recode + 
#               pandemic_period*sex + 
#               year + 
#               month + 
#               pandemic_period*agec + 
#               offset(log(pop.interpol)),  data=a3  )
# 
# summary(mod1)


```


## Single group by age
```{r}


b1 <- a3 %>%
  mutate(qtr=as.factor(quarter(date))) %>%
  group_by(year,month,qtr,pandemic_period, agey) %>%
    summarize(N_deaths=sum(N_deaths), pop=sum(pop.interpol)) %>% 
  ungroup() %>%
  group_by(year,qtr,pandemic_period, agey) %>%
  summarize(N_deaths=sum(N_deaths), pop=mean(pop)) %>% # for the quarters, take mean so don't double count people
  mutate(log.offset=log(pop/100000), raw_prob_death= N_deaths/pop)

mod.test <- glm(N_deaths ~ offset(log.offset) +agey, data=b1, family='poisson')
```



```{r, eval=F}

mod.mat <- model.matrix(~ agey +pandemic_period +qtr, data=b1)

model_string <- "
model{
for(t in 1:N_times){ 
  N_deaths[t] ~ dnegbin(prob[t],r)
  prob[t]<- r/(r+lambda[t])
  
  #N_deaths[t] ~ dpois(lambda[t])
  
  log(lambda[t]) <- ( int  + 
  log.offset[t] + #offset
  beta[agey[t]+1] + #age-specific intercept
  pandemic[t]*delta[agey[t]+1] + #age specific pandemic effect 
  epsilon[agey[t]+1]*t #age specific trend
  )

}
  
  beta[1] ~ dnorm(0, (1-rho^2)*tau.beta)
  baseline_prob[1] <- beta[1] +int
  
  for(i in 2:101){
      beta[i] ~ dnorm(rho*beta[i-1], tau.beta) #AR(1) model
      baseline_prob[i] <- beta[i] +int
  }
  
  delta[1] ~ dnorm(0, (1-rho2^2)*tau.delta)
    for(i in 2:101){
      delta[i] ~ dnorm(rho2*delta[i-1], tau.delta) #AR(1) model
    }
  
    
  epsilon[1] ~ dnorm(0, (1-rho3^2)*tau.epsilon)
    for(i in 2:101){
      epsilon[i] ~ dnorm(rho2*epsilon[i-1], tau.epsilon) #AR(1) model
  }
  
   int ~ dnorm(0, 1e-4)
   
   tau.beta~ dgamma(3, 2)
   tau.delta~ dgamma(3,2)
   tau.epsilon~ dgamma(3,2)

   rho ~ dunif(-1,1)
   rho2 ~ dunif(-1,1)
   rho3 ~ dunif(-1,1)
   
    r ~ dunif(0,250)

 }
"
##############################################################
#Model Fitting
##############################################################
inits1=list(".RNG.seed"=c(123), ".RNG.name"='base::Wichmann-Hill')
inits2=list(".RNG.seed"=c(456), ".RNG.name"='base::Wichmann-Hill')
inits3=list(".RNG.seed"=c(789), ".RNG.name"='base::Wichmann-Hill')
##############################################
#Model Organization
##############################################
model_spec<-textConnection(model_string)
model_jags<-jags.model(model_spec, 
                       inits=list(inits1,inits2, inits3),
                       data=list('N_deaths'=b1$N_deaths ,
                                 'N_times'=nrow(b1) ,
                                 'log.offset'=b1$log.offset,
                                 'agey'=b1$agey,
                                 'pandemic'=b1$pandemic_period
                                    ),
                       n.adapt=10000, 
                       n.chains=3)

params<-c( 'beta','delta','epsilon','rho','tau.beta','int','baseline_prob')
##############################################
#Posterior Sampling
##############################################
posterior_samples<-coda.samples(model_jags, 
                                params, 
                                n.iter=10000)
posterior_samples.all<-do.call(rbind,posterior_samples)

saveRDS(posterior_samples.all, './Results/posteriors.rds')
```


```{r}
posterior_samples.all <- readRDS( './Results/posteriors.rds')

#post1.summary<-summary(posterior_samples)
#post_means<-colMeans(posterior_samples.all)
post_means<-apply(posterior_samples.all, 2, mean)
sample.labs<-names(post_means)
ci<-t(hdi(posterior_samples.all, credMass = 0.95))
#ci<-matrix(sprintf("%.1f",round(ci,1)), ncol=2)
ci<-matrix(ci, ncol=2)
row.names(ci)<-sample.labs
#post_means<-sprintf("%.1f",round(post_means,1))
names(post_means)<-sample.labs
indices <- str_extract_all(names(post_means), "(?<=\\[).+?(?=\\])")
rep1 <- sapply(indices, function(x) identical(x, character(0))) #is it missing ie character(0)
indices[which(rep1==1)] <- '999'
index_n <- as.numeric(unlist(indices))

combined <- cbind.data.frame(post_means, ci,index_n )

post_beta<- as.data.frame(combined[grep('beta',names(post_means)),]) %>%
  filter(index_n<=101)

post_delta<- as.data.frame(combined[grep('delta',names(post_means)),]) %>%
  filter(index_n<=101)

post_epsilon<- as.data.frame(combined[grep('epsilon',names(post_means)),]) %>%
  filter(index_n<=101)

post_baseline_prob<- as.data.frame(combined[grep('baseline_prob',names(post_means)),]) 

# ggplot(post_beta, aes(x=index_n, y=exp(post_means))) +
#   theme_classic() +
#   geom_ribbon(aes(x=index_n, ymin=exp(`1`), ymax=exp(`2`)),fill='gray80') +
#   geom_line()+
#   ggtitle('Mortality ratio by Age') +
#     xlab('Age (years)')

ggplot(post_baseline_prob, aes(x=index_n, y=(post_means))) +
  theme_classic() +
  geom_ribbon(aes(x=index_n, ymin=(`1`), ymax=(`2`)),fill='gray80') +
  geom_line()+
  ggtitle('Log-Deaths/100000 per quarter') +
    xlab('Age (years)')


ggplot(post_baseline_prob, aes(x=index_n, y=exp(post_means))) +
  theme_classic() +
  geom_ribbon(aes(x=index_n, ymin=exp(`1`), ymax=exp(`2`)),fill='gray80') +
  geom_line()+
  ggtitle('Pre-pandemic rate of death') +
    xlab('Age (years)') +
  ylab('Deaths/100000 per quarter')

ggplot(post_delta, aes(x=index_n, y=exp(post_means))) +
  theme_classic() +
  geom_ribbon(aes(x=index_n, ymin=exp(`1`), ymax=exp(`2`)),fill='gray80') +
  geom_line()+
  ggtitle('Pandemic effect (RR) by Age') +
    xlab('Age (years)') +
  ylab('Pandemic effect (RR')+
    geom_hline(yintercept=1)



ggplot(post_epsilon, aes(x=index_n, y=exp(post_means))) +
  theme_classic() +
  geom_ribbon(aes(x=index_n, ymin=exp(`1`), ymax=exp(`2`)),fill='gray80') +
  geom_line()+
  ggtitle('Time trend by Age') +
    xlab('Age (years)') +
  geom_hline(yintercept=1)+
  ylab('RR per quarter')


```


excess deaths and LE
```{r}

rate_death <- exp(post_baseline_prob$post_means)/100000 #quarterly rate

#conditional probability of death per year
annual_prob_death <- 1- exp(-1*rate_death*4) #annual probability of death; compare to: https://www.ssa.gov/oact/STATS/table4c6.html
annual_prob_death[101] <- 1 #by kissler's assumption, if survive to 100, probability of death=1

post_delta_rr <- post_delta %>%
    mutate(agey= index_n -1) %>%
  mutate(pandemic_rr=exp(post_means),pandemic_rr_lcl=exp(`1`),pandemic_rr_ucl=exp(`2`) ) %>%
  select(agey,starts_with('pandemic_rr'))

life_table <- cbind.data.frame('prob_death_cond'=annual_prob_death) %>% #prob of dying in this year conditional on having suvived
  mutate(agey=0:100,
         prob_death_uncond= calc_pdeath_inst(prob_death_cond)
         
        ) %>% #unconditional probability of dying at this age
  left_join(post_delta_rr, by='agey') %>%
  mutate(rate_death_cond = -1/1*log(1-prob_death_cond),
         rate_death_cond_pandemic=rate_death_cond*pandemic_rr ,
         prob_death_cond_pandemic = 1 - exp(-1*rate_death_cond_pandemic),
         excess_cond_prob_death= prob_death_cond_pandemic - prob_death_cond,
         
         #Then calculate excess unconditional probability of death
         log_prob_surv_pandemic =log(1-prob_death_cond_pandemic), 
         cum_log_prob_surv_pandemic=cumsum(log_prob_surv_pandemic) - log_prob_surv_pandemic , #log probability survive to this point
         cum_prob_surv_pandemic=exp(cum_log_prob_surv_pandemic), #probability survive to this point
         prob_death_uncond_pandemic= prob_death_cond_pandemic*cum_prob_surv_pandemic,
         prob_death_uncond_pandemic= prob_death_uncond_pandemic/sum(prob_death_uncond_pandemic)
         
         ) #excess probability of death, by age


life_expect_birth <-  life_table %>%
  mutate(piece = (agey+0.5)*prob_death_uncond) %>%
  summarize(le = sum(piece))

plot(life_table$prob_death_cond, type='l')
points(life_table$prob_death_cond_pandemic, type='l', col='red', lty=2)

#Unconditional probability of dying by age; by definition, if shift earlier, fewer people will die later
plot(life_table$prob_death_uncond, type='l')
points(life_table$prob_death_uncond_pandemic, type='l', col='red', lty=2)


plot(life_table$cum_prob_surv, type='l')
points(life_table$cum_prob_surv_pandemic, type='l', col='red', lty=2)


# Create a life matrix using the baseline probabilities of death: 
m <- make_upper_tri(life_table$prob_death_uncond, shift=FALSE)
m <- norm_rows(m)
m_init <- m

##go in reverse--from life matrix, calculate incidence
#diagonal of m gives conditional probability by age
m_diag <- diag(m)
#m_diag[101] <- 0.999999
rate_death_annual = -1/1*log(1-m_diag)

pop <- b1 %>% ungroup() %>%
  filter(year==2019 ) %>% select(pop, agey,N_deaths) %>%
  group_by(agey) %>%
  summarize(pop=mean(pop), Obs_deaths2019=sum(N_deaths)) %>%
  ungroup()

N_death_annual1 <- pop$pop * m_diag
#N_death_annual2 <- pop$pop * rate_death_annual

 plot(N_death_annual1, pop$Obs_deaths2019)
 abline(a=0, b=1)
 

trng <- -5:20

k <- 2

le_sim_2 <- sim_covid(trng, life_table$prob_death_uncond, life_table$pandemic_rr, k)

fig_le_example <- le_sim_2$le %>% 
	ggplot(aes(x=t, y=le)) + 
		geom_point() + 
		geom_line()

fig_le_example #artifactual drop and spike in life expectancy


prob_death_sim <- le_sim_2$prob_death 

N_death_sim <- apply(prob_death_sim,2, function(x) x*pop$pop)

colnames(N_death_sim) <- 1:ncol(N_death_sim)

N_death_sim.m <- reshape2::melt(N_death_sim) %>%
  rename(agey=Var1, year_index=Var2) %>%
   mutate( agec =if_else(agey>=0 & agey<18,1, 
                        if_else(agey>=18 & agey<40,2,
                        if_else(agey>=40 & agey<65,3,
                        if_else(agey>=65 & agey<85,4,
                        if_else(agey>=85 & agey<101,5, 999)))))) %>%
  group_by(agec, year_index) %>%
  summarize(expected_N_deaths=sum(value)) %>%
  mutate(year= year_index-6)


	ggplot(N_death_sim.m, aes(x=year, y=expected_N_deaths)) + 
		geom_point() + 
		geom_line() +
	  ylim(0,NA)+
	  theme_classic()+
	  facet_wrap(~agec, scales='free' )



```


## Competing risks

People can die from COVID, or they can die from something else. Probability of death from something else can be determined from baseline death rate

start with N people, each quarter, probability of being alive is (1-P_die) for 3 quarters it (1-P_die)^3 

** important note: as in Kissler and grad,ned to convert probabilities to rates before multiplying with RR, then convert back to probability ** 

```{r}

P_die_qtr_base <- exp(7.5302187)/100000 # probability an 84 year old dies in a quarter

rate_die_qtr_base <- -log(1-P_die_qtr_base) #convert probability to rate
  
RR_Pandemic <- exp(0.164847030)

rate_die_qtr_pandemic <- rate_die_qtr_base*RR_Pandemic #multiple rate by RR

P_die_qtr_pandemic <- 1 - exp(-rate_die_qtr_pandemic*1) #convert rate back to probability

P_die_virus <- P_die_qtr_pandemic - P_die_qtr_base #Prob excess deaths; most of which are virus

P_die_year <- 1 - (1 - P_die_qtr_base)^4 #0.072 pretty close to government estimate of 0.064 for women and 0.085 for men https://www.ssa.gov/oact/STATS/table4c6.html#fn1

P_die_pandemic <- 1 - (1 - P_die_qtr_pandemic)^4


#Category 1= alive

#Category 2= die covid

#Category 3= die other

#Start with a cohort of 1000

t <- 1:40 #  10 years of quarterly data

Alive <- rep(NA, length(t))
Die_COVID <- rep(NA, length(t))
Die_Other <- rep(NA, length(t))

Alive[1] <- 1000
Die_COVID[1] <- 0
Die_Other[1] <- 0

for(i in 2:length(t)) {
  
  Alive[i] <- Alive[i-1] - Alive[i-1] * P_die_qtr_base  - Alive[i-1] * P_die_virus
  Die_COVID[i] <- Die_COVID[i-1] + Alive[i-1] * P_die_virus #cumulative deaths covid
  Die_Other[i] <- Die_Other[i-1] + Alive[i-1] * P_die_qtr_base #cumulative deaths other

}

plot(Die_COVID)

```
 
 It might make sense to focus in on people with certain conditions, like cancer; diabetes; etc.
 Need prevalence info by age and ethnicity; could get from the VA
 
```{r}
#should be 282,801 diabetes deaths in US in 2019 according to CDC wonderi in E10-E14
d1 <- readRDS('./Data/diabetes_covid_deaths_line_list_no_geo.rds')

 d1 %>%
  filter(year %in% c(2019,2020)) %>%
   dplyr::group_by(year) %>%
  dplyr::summarize(N_diabetes=sum(diabetes), N_covid_diabetes=sum(covid_diabetes))

 
summary1 <- d1 %>%
  group_by(age_group,race_recode,year) %>%
  filter(year %in% c(2018,2019,2020)) %>%
  summarize(diabetes=sum(diabetes), covid_diabetes=sum(covid_diabetes)) %>%
  reshape2::dcast( race_recode +age_group ~ year, value.var='diabetes') %>%
  mutate(ratio20_19=`2020`/`2019`, ratio19_18=`2019`/`2018`)
  
#This plots shows little year-over-year increase 2018-2019, larges in crease 2019-2020 (not just secular trend)
plot(summary1$ratio20_19, summary1$ratio19_18)
#View(summary1)

```
 
 